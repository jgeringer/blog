<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://unpkg.com/@contentful/app-sdk@3"></script>
<link href="https://static.contentful.com/app/main-62e0abc7.css" media="all" rel="stylesheet" type="text/css">
<link href="https://static.contentful.com/app/vendor-976872d7.css" media="all" rel="stylesheet" type="text/css">
<link href="https://unpkg.com/contentful-ui-extensions-sdk@3/dist/cf-extension.css" media="all" rel="stylesheet" type="text/css">
<script>
window.contentfulExtension.init(function(api) {
  console.log(api.field.getValue());
});
</script>
<style>
  input.form-control {
    -webkit-appearance: textfield;
    background-color: #fff;
    border: 1px solid #cfd9e0;
    border-radius: 6px;
    -webkit-box-shadow: inset 0 2px 0 #e1e4e833;
    box-shadow: inset 0 2px 0 #e1e4e833;
    color: #414d63;
    font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;
    font-size: .875rem;
    margin: 0;
    max-height: 2.5rem;
    outline: none;
    padding: 10.5px;
    height: 40px;
    width: 100%;
  }
  input.form-control:focus {
    border: 1px solid #036fe3;
    -webkit-box-shadow: 0 0 0 3px #98cbff;
    box-shadow: 0 0 0 3px #98cbff;
    outline: none;
	}
  .widget-slug-editor { overflow: hidden; }
  input.form-control[readonly] {
    border: 1px solid #cfd9e0;
    background: #fff;
  }
  .entity-editor__field-hint {
    color: rgb(103, 114, 138);
    font-style: italic;
    margin: 9px 0;
    width: 100%;
}
  }
</style>
</head>
  <body>

<div class="widget-slug-editor">
  <input id="slug" type="text" class="form-control" readonly>
  <i id="error" class="fa fa-exclamation-triangle is-slug-duplicate"></i>
  <i id="ok" class="fa fa-check-circle is-slug-unique"></i>
  <i id="loading" class="fa fa-spinner fa-spin"></i>
</div>
    <div class="entity-editor__field-hint" role="note" data-test-id="field-hint">The url slug of the page is autogenerated based off of the title.</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.0.2/es6-promise.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/speakingurl/7.0.0/speakingurl.min.js"></script>

<script>
var cfExt = window.contentfulExtension || window.contentfulWidget

cfExt.init(function (api) {
  var slugField = api.field
  var titleFieldName = api.contentType.displayField
  var titleField = api.entry.fields[titleFieldName]
  
  console.log('titleField: ' + titleField)
  
  var typeField = api.entry.fields['type'] || null;
  var typeFieldValue = typeField ? typeField.getValue() : null;
 
  var currentContentType = api.contentType.name.toLowerCase();
  
  switch (currentContentType) {
    case 'recipe':
      currentContentType = 'kitchen'
      break;
    case 'pizzaria':
      currentContentType = 'pizzas'
      break;
  }
  
  console.log('currentContentType: ' + currentContentType)
  

  var _ = window._
  var getSlug = window.getSlug
  var debouncedUpdateStatus = _.debounce(updateStatus, 500)

  var input = document.getElementById('slug')
  var statusElements = {
    error: document.getElementById('error'),
    ok: document.getElementById('ok'),
    loading: document.getElementById('loading')
  }

  api.window.updateHeight()
  
  titleField.onValueChanged(handleSlugChange)
  typeField.onValueChanged(handleTypeChange)

  input.addEventListener('change', function () {
    setSlug(input.value.replace('/article/', ''))
  })
  
  updateStatus(slugField.getValue())

  /**
   * Handle change of slug value caused by either changing slug field
   * or changing the title of the entry
   */
  
  function handleSlugChange (value) {
    setSlug(getSlug(value || ''), typeFieldValue)
  }
  
  function handleTypeChange (value) {
    setSlug(getSlug(api.entry.fields['title'].getValue()), value)
  }


  
  /**
   * Set the input value to 'slug' and update the status by checking for
   * duplicates.
   */
  function setSlug (slug, type) {
    typeFieldValue = type;
    var preSlug;
    if (typeFieldValue) {
      preSlug = `/${currentContentType}/${typeFieldValue}/${slug}`
    } else {
      preSlug = `/${currentContentType}/${slug}`
    }
    input.value = preSlug
    slugField.setValue(preSlug)
    setStatus('loading')
    debouncedUpdateStatus(slug)
  }

  /**
   * Show inline status icon based on current status
   */
  function updateStatus (slug) {
    getDuplicates(slug).then(function (hasDuplicates) {
      if (hasDuplicates) {
        setStatus('error')
      } else {
        setStatus('ok')
      }
    })
  }

  /**
   * Show icon for given status
   */
  function setStatus (status) {
    _.each(statusElements, function (el, name) {
      if (name === status) {
        el.style.display = 'inline'
      } else {
        el.style.display = 'none'
      }
    })
  }


  /**
   * Check if slug is already in use.
   * Resolves to 'true' if there are entries of the given content type that have
   * the same 'slug' value.
   */
  function getDuplicates (slug) {
    if (!slug) {
      return Promise.resolve(false)
    }

    var query = {}

    query['content_type'] = api.entry.getSys().contentType.sys.id
    query['fields.' + slugField.id] = slug
    query['sys.id[ne]'] = api.entry.getSys().id
    query['sys.publishedAt[exists]'] = true

    return api.space.getEntries(query).then(function (result) {
      return result.total > 0
    })
  }
})
</script>
</body>